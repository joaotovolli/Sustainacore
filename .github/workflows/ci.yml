name: CI

on:
  pull_request:
  workflow_dispatch:

jobs:
  guard-secrets:
    name: Ensure sensitive files are ignored
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify that sensitive files are not committed
        run: |
          set -euo pipefail
          files=$(git ls-files -- ':**/.env' ':**/wallet/**')
          if [ -n "$files" ]; then
            echo "The following sensitive files are committed:" >&2
            echo "$files" >&2
            exit 1
          fi
          echo "No tracked .env or wallet files detected."

  guard-forbidden-terms:
    name: Guard forbidden terms
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Scan for forbidden provider terms
        run: |
          set -euo pipefail
          python3 tools/guard_forbidden_terms.py

  persona-guard:
    name: Persona guard (manual eval lives in persona-eval)
    runs-on: ubuntu-latest
    steps:
      - name: Provide guidance
        env:
          EVAL_BASE_URL: ${{ secrets.EVAL_BASE_URL }}
        run: |
          {
            echo "## Persona guard";
            echo "Full persona evaluation runs only via the **Persona eval** workflow (manual dispatch).";
            if [ -n "${EVAL_BASE_URL}" ]; then
              echo "- Secret \`EVAL_BASE_URL\` is configured; the manual persona eval can run when needed.";
            else
              echo "- Secret \`EVAL_BASE_URL\` is not configured; set it to enable manual persona eval runs.";
            fi
            echo;
            echo "Use **Actions → Persona eval → Run workflow** to execute the full evaluation when you need persona coverage.";
          } >> "$GITHUB_STEP_SUMMARY"

  vrt-mobile:
    name: Mobile VRT (desktop hard gate)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: website_django/package-lock.json
      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python3 -m pip install -r website_django/requirements.txt
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('website_django/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-
      - name: Install Node dependencies
        run: |
          set -euo pipefail
          cd website_django
          npm ci
      - name: Install Playwright browsers
        run: |
          set -euo pipefail
          cd website_django
          npx playwright install --with-deps chromium
      - name: Capture baseline (main)
        run: |
          set -euo pipefail
          git fetch origin main
          git worktree add /tmp/sustainacore-main origin/main
          cd website_django
          node scripts/run_mobile_vrt_ci.mjs --mode baseline --repo-root /tmp/sustainacore-main
      - name: Capture current (PR)
        run: |
          set -euo pipefail
          cd website_django
          node scripts/run_mobile_vrt_ci.mjs --mode current --repo-root "$GITHUB_WORKSPACE"
      - name: Diff screenshots
        run: |
          set -euo pipefail
          cd website_django
          node scripts/mobile_vrt_diff.mjs
      - name: Upload VRT artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mobile-vrt-artifacts
          path: artifacts/vrt
