name: Sanity

on:
  pull_request:
    paths:
      - ".github/workflows/**"
      - "website_django/**"
      - "**/*.py"
      - "**/*.sh"
  workflow_dispatch:

jobs:
  sanity:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/website_django
      DJANGO_SETTINGS_MODULE: core.settings
      DJANGO_SECRET_KEY: test-secret-key

    steps:
      - uses: actions/checkout@v4

      # Determine what changed in the PR WITHOUT relying on git merge-base.
      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            website:
              - 'website_django/**'

      - name: Fail on conflict markers
        run: |
          ! git grep -nE '^(<<<<<<<|=======|>>>>>>>)' -- . ':(exclude)website_django/venv/**' || \
            (echo 'ERROR: conflict markers present' && exit 1)

      # Only set up Python + deps if website_django changed
      - uses: actions/setup-python@v5
        if: steps.changes.outputs.website == 'true'
        with:
          python-version: "3.11"

      - name: Install minimal test deps (VM2 only)
        if: steps.changes.outputs.website == 'true'
        run: |
          python -m pip install -U pip wheel
          python -m pip install Django==5.2.8 pytest pytest-django

      - name: Compile website tree
        if: steps.changes.outputs.website == 'true'
        run: python -m compileall -q website_django

      - name: Run website tests
        if: steps.changes.outputs.website == 'true'
        run: pytest -q website_django/core/tests/test_api_client.py

      - name: Sanity guidance
        if: failure()
        run: |
          {
            echo "## Sanity check failed";
            echo "- Inspect the logs above.";
            echo "- This workflow only runs VM2 checks when website_django/** changes.";
          } >> "$GITHUB_STEP_SUMMARY"
