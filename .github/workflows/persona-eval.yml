name: Persona eval

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  persona-skip:
    name: Persona eval (manual-only – skipped)
    if: ${{ github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    env:
      ASK2_URL: ${{ secrets.ASK2_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ORG_ID: ${{ secrets.ORG_ID }}
    steps:
      - name: Explain manual trigger
        run: |
          {
            echo "## Persona eval (manual-only)";
            echo "This workflow only runs the full evaluation when dispatched manually from the Actions tab.";
            echo "- Trigger via **Actions → Persona eval → Run workflow** to validate persona responses.";
            if [ -n "${ASK2_URL}" ] && [ -n "${OPENAI_API_KEY}" ] && [ -n "${ORG_ID}" ]; then
              echo "- Required secrets appear to be set; manual runs should succeed.";
            else
              echo "- Set secrets ASK2_URL, OPENAI_API_KEY, and ORG_ID before dispatching to run the eval.";
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  preflight:
    name: Preflight checks
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.check.outputs.ready }}
      missing: ${{ steps.check.outputs.missing }}
      reason: ${{ steps.check.outputs.reason }}
    steps:
      - name: Inspect required secrets
        id: check
        uses: actions/github-script@v7
        env:
          ASK2_URL: ${{ secrets.ASK2_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ORG_ID: ${{ secrets.ORG_ID }}
        with:
          script: |
            const required = ["ASK2_URL", "OPENAI_API_KEY", "ORG_ID"];
            const env = process.env;
            const missing = required.filter((name) => !(env[name] || "").trim());
            const messages = [];
            if (missing.length) {
              messages.push("missing secrets: " + missing.join(", "));
            }
            const url = (env.ASK2_URL || "").trim();
            if (!url) {
              messages.push("ASK2_URL not configured");
            } else {
              try {
                const parsed = new URL(url);
                if (!parsed.protocol || !parsed.host) {
                  messages.push("ASK2_URL must be absolute (e.g., https://example.org/ask2)");
                }
              } catch (error) {
                messages.push("ASK2_URL must be absolute (e.g., https://example.org/ask2)");
              }
            }
            const ready = messages.length === 0;
            const reason = messages.join("; ");
            core.setOutput("ready", ready ? "true" : "false");
            core.setOutput("missing", missing.join("|"));
            core.setOutput("reason", reason);
            core.info("Preflight status: " + (ready ? "ready" : reason || "unknown issue"));

  persona-eval:
    name: Run persona eval
    needs: preflight
    if: ${{ github.event_name == 'workflow_dispatch' && needs.preflight.outputs.ready == 'true' }}
    runs-on: ubuntu-latest
    env:
      ASK2_URL: ${{ secrets.ASK2_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ORG_ID: ${{ secrets.ORG_ID }}
      EVAL_FLAGS: "REQUEST_NORMALIZE,PERSONA_V1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip wheel
          pip install -r requirements.txt

      - name: Print resolved URL
        run: echo "ASK2_URL=${ASK2_URL}"

      - name: Run eval pack
        run: python scripts/run_eval.py

  persona-eval-skip:
    name: Persona eval skipped (missing secrets)
    needs: preflight
    if: ${{ github.event_name == 'workflow_dispatch' && needs.preflight.outputs.ready != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Skip message
        env:
          REASON: ${{ needs.preflight.outputs.reason }}
        run: |
          {
            echo "## Persona eval skipped";
            echo "Persona eval was not run because prerequisites are missing.";
            echo "Reason: ${REASON:-Check repository secrets configuration.}";
            echo "Set ASK2_URL, OPENAI_API_KEY, and ORG_ID, then re-run the workflow.";
          } >> "$GITHUB_STEP_SUMMARY"
