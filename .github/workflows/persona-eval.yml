name: Persona eval

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preflight:
    name: Preflight checks
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.check.outputs.ready }}
      missing: ${{ steps.check.outputs.missing }}
      reason: ${{ steps.check.outputs.reason }}
    steps:
      - name: Inspect required secrets
        id: check
        env:
          ASK2_URL: ${{ secrets.ASK2_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ORG_ID: ${{ secrets.ORG_ID }}
        run: |
          python - <<'PY'
import os
from urllib.parse import urlparse

required = ["ASK2_URL", "OPENAI_API_KEY", "ORG_ID"]
missing = [name for name in required if not os.getenv(name, "").strip()]
messages = []
if missing:
    messages.append("missing secrets: " + ", ".join(missing))
url = os.getenv("ASK2_URL", "").strip()
if url:
    parsed = urlparse(url)
    if not (parsed.scheme and parsed.netloc):
        messages.append("ASK2_URL must be an absolute URL (e.g., https://example.org/ask2)")
else:
    messages.append("ASK2_URL not configured")
ready = not messages
reason = "; ".join(messages) if messages else ""
with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
    fh.write(f"ready={'true' if ready else 'false'}\n")
    fh.write("missing=" + ("|".join(missing) if missing else "") + "\n")
    fh.write(f"reason={reason}\n")
print("Preflight status:", "ready" if ready else reason or "unknown issue")
PY

  persona-eval:
    name: Run persona eval
    needs: preflight
    if: ${{ needs.preflight.outputs.ready == 'true' }}
    runs-on: ubuntu-latest
    env:
      ASK2_URL: ${{ secrets.ASK2_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ORG_ID: ${{ secrets.ORG_ID }}
      EVAL_FLAGS: "REQUEST_NORMALIZE,PERSONA_V1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip wheel
          pip install -r requirements.txt

      - name: Print resolved URL
        run: echo "ASK2_URL=${ASK2_URL}"

      - name: Run eval pack
        run: python scripts/run_eval.py

  persona-eval-skip:
    name: Skip summary
    needs: preflight
    if: ${{ needs.preflight.outputs.ready != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Skip message
        env:
          REASON: ${{ needs.preflight.outputs.reason }}
        run: |
          echo "SKIP: persona eval not run. ${REASON:-Check repository secrets configuration.}"
