Gemini Jobs Worker Instructions (worker-only)

Purpose
- This worker processes `PROC_GEMINI_JOBS` routines without touching Ask2 code paths, services, or env.
- All mutations to `ESG_DOCS` require explicit approval in `PROC_GEMINI_APPROVALS`.

RAG_INGEST routine
- Input: CSV attachment in `PROC_GEMINI_JOBS.FILE_BLOB`.
- Output: approval request with attached payload file describing intended `ESG_DOCS` inserts.
- Approval payload columns:
  - SOURCE_TYPE, SOURCE_ID, SOURCE_URL, TITLE, CHUNK_IX, CHUNK_TEXT

Field mapping
- SOURCE_TYPE: `PROC_GEMINI_JOB`.
- SOURCE_ID: deterministic short hash based on `JOB_ID`, `ROW_IX`, `CHUNK_IX`, and normalized chunk text; must be <= 120 chars.
- SOURCE_URL: best available URL/source field if present; else empty.
- TITLE: best available column (company/name/ticker/title); else `RAG Ingest Row <n>`.
- CHUNK_IX: 1-based chunk number.
- CHUNK_TEXT: formatted text including title, dates, key fields, and sources (include `Sources:` lines if present).
- EMBEDDING: generated by the existing embedding client; must be 384 dimensions.

Safety rules
- Create approval BEFORE any insert into `ESG_DOCS`.
- Never modify Ask2 prompts, services, env vars, or code paths.
- Skip inserts when `SOURCE_ID` already exists (idempotent).
- If embedding dimension != 384, STOP and create an approval request type `OTHER` explaining the mismatch.

Approval requirements
- REQUEST_TYPE: `ADD_VECTORS`.
- TITLE: `RAG ingest: <filename> (JOB <id>)`.
- PROPOSED_TEXT: rows, chunks, date range, and detected columns.
- DETAILS: schema mapping + dedupe strategy + embedding checks.
- GEMINI_COMMENTS: row count, detected columns, dedupe strategy, expected chunks, warnings.
- Attach payload file with the proposed inserts (no embedding vectors).

RAG_INGEST (Text to be transformed and added to RAG Vectors)
- Payload columns (CSV): source_type, source_id, source_url, title, chunk_ix, chunk_text
- Chunking rules:
  - Never start or end mid-word.
  - Prefer sentence boundaries; fall back to whitespace.
  - Each chunk must start with the header line `Company:`.
  - Target 900–1400 characters; overlap only when boundary-aligned.
- Structured chunk_text format:
  - Company: <name> (<ticker>)
  - Section: AI Governance & Ethics Signals
  - Summary: <1–3 sentences from input row>
  - Evidence:
    - <bullet>
  - Sources:
    - <source reference>
  - Metadata: <date/as-of>, <key fields>
- Source URL:
  - Use explicit source/url column when present.
  - Otherwise: sustainacore://proc_gemini_job/<JOB_ID>/row/<ROW_KEY>/chunk/<CHUNK_IX>
- SOURCE_ID format (<=120 chars):
  - PGJ:<job_id>:<row_key>:<chunk_ix>:<hash12>
- Do not invent facts. Use only values from the input row.

Self-improving notes
- Append to "## Learned Notes" only when the worker struggled:
  - CLI error, CSV parse issue, missing columns, embedding mismatch, retry, or insert failure.
- Append-only; never edit or delete older notes.
- Use stable note ids to avoid duplicate entries.

## Learned Notes
- [2026-01-01 15:29:42Z] Approval table missing GEMINI_COMMENTS column | context=stored in DETAILS instead [note-id:1146c26699ef]
- [2026-01-01 16:20:00Z] Prior approval rejected due to mid-word chunking and weak traceability; added boundary-aligned chunking and internal URLs [note-id:4a7c3b7c9c7d]
