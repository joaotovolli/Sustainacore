{% extends "base.html" %}
{% load static %}

{% block title %}TECH100 Index | Performance{% endblock %}

{% block extra_head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
{% endblock %}

{% block content %}
<div class="tech100-index">
  <section class="section section--with-header">
    <div class="shell">
      <div class="section__header section__header--split">
        <div>
          <span class="pill pill--soft">TECH100 AI Index</span>
          <h1>TECH100 Performance</h1>
          <p class="muted">Live Oracle-backed index performance, attribution, and holdings intelligence.</p>
        </div>
        <div class="meta-stack">
          <div class="meta-pill">Rebalance: {{ rebalance_date|default:"—" }}</div>
          <div class="meta-pill">Universe date: {{ universe_date|default:"—" }}</div>
        </div>
      </div>

      {% with tech100_current="Performance" %}
        {% include "partials/tech100_nav.html" %}
      {% endwith %}

      {% if data_error %}
        <div class="alert alert--warning" data-tech100-empty-state="1">
          Live TECH100 data is temporarily unavailable; please try again later.
        </div>
      {% else %}
        <div id="tech100-performance-status"
             data-tech100-performance-has-data="1"
             data-level-count="{{ levels_count }}"
             data-holdings-count="{{ holdings_count }}"
             data-attribution-count="{{ attribution_count }}"></div>

        <div class="card tech100-tools">
          <div>
            <h2 class="h5">Tools</h2>
            <p class="muted">Export the latest holdings and attribution tables.</p>
          </div>
          <div class="tech100-tools__actions">
            <a class="btn btn--secondary" href="/tech100/performance/export/?kind=holdings">Download holdings CSV</a>
            <a class="btn btn--secondary" href="/tech100/performance/export/?kind=attribution">Download attribution CSV</a>
            <button class="btn btn--ghost" type="button" data-copy-link="1">Copy link</button>
          </div>
        </div>

        <div class="tech100-context">
          <div class="tech100-context__item">
            <span class="muted">Latest trade date</span>
            <strong>{{ latest_date }}</strong>
          </div>
          <div class="tech100-context__item">
            <span class="muted">Levels</span>
            <strong>{{ levels_count }}</strong>
          </div>
          <div class="tech100-context__item">
            <span class="muted">Holdings</span>
            <strong>{{ holdings_count }}</strong>
          </div>
          <div class="tech100-context__item">
            <span class="muted">Attribution rows</span>
            <strong>{{ attribution_count }}</strong>
          </div>
        </div>

        <div class="tech100-module-grid">
          <a class="tech100-module-card" href="/tech100/index/">
            <span class="tech100-module-card__title">Index overview</span>
            <span class="muted">Performance, risk, and data quality signals.</span>
          </a>
          <a class="tech100-module-card is-active" href="/tech100/performance/">
            <span class="tech100-module-card__title">Performance</span>
            <span class="muted">Levels, drawdowns, volatility, and attribution.</span>
          </a>
          <a class="tech100-module-card" href="/tech100/constituents/">
            <span class="tech100-module-card__title">Constituents</span>
            <span class="muted">Daily holdings, weights, and quality flags.</span>
          </a>
          <a class="tech100-module-card" href="/tech100/attribution/">
            <span class="tech100-module-card__title">Attribution</span>
            <span class="muted">Top contributors and detractors by date.</span>
          </a>
          <a class="tech100-module-card" href="/tech100/stats/">
            <span class="tech100-module-card__title">Stats</span>
            <span class="muted">Volatility, drawdown, and concentration metrics.</span>
          </a>
          <a class="tech100-module-card" href="/tech100/">
            <span class="tech100-module-card__title">Governance scores</span>
            <span class="muted">TECH100 ranking and filters.</span>
          </a>
        </div>

        <div class="tech100-section-nav">
          <a class="tech100-section-nav__link" href="#overview">
            <span>Overview</span>
            <span class="tech100-section-nav__meta">{{ levels_count }} levels</span>
          </a>
          <a class="tech100-section-nav__link" href="#attribution">
            <span>Attribution</span>
            <span class="tech100-section-nav__meta">{{ attribution_count }} rows</span>
          </a>
          <a class="tech100-section-nav__link" href="#holdings">
            <span>Holdings</span>
            <span class="tech100-section-nav__meta">{{ holdings_count }} names</span>
          </a>
        </div>

        <div class="card tech100-performance__overview" id="overview">
          <div class="tech100-performance__header">
            <div>
              <h2 class="h4">Overview</h2>
              <p class="muted">As of {{ latest_date }} (UTC)</p>
            </div>
            <div class="tech100-index__range">
              <button class="btn btn--ghost tech100-range-btn {% if range_key == '1m' %}is-active{% endif %}" data-range="1m">1M</button>
              <button class="btn btn--ghost tech100-range-btn {% if range_key == '3m' %}is-active{% endif %}" data-range="3m">3M</button>
              <button class="btn btn--ghost tech100-range-btn {% if range_key == '6m' %}is-active{% endif %}" data-range="6m">6M</button>
              <button class="btn btn--ghost tech100-range-btn {% if range_key == 'ytd' %}is-active{% endif %}" data-range="ytd">YTD</button>
              <button class="btn btn--ghost tech100-range-btn {% if range_key == '1y' %}is-active{% endif %}" data-range="1y">1Y</button>
              <button class="btn btn--ghost tech100-range-btn {% if range_key == 'max' %}is-active{% endif %}" data-range="max">Max</button>
            </div>
          </div>
          <div class="tech100-performance__charts">
            <div class="chart-card">
              <h3 class="h5">Index level</h3>
              <div class="chart-card__canvas">
                <canvas id="tech100-performance-level-chart" role="img" aria-label="TECH100 index level chart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3 class="h5">Drawdown</h3>
              <div class="chart-card__canvas">
                <canvas id="tech100-performance-drawdown-chart" role="img" aria-label="TECH100 drawdown chart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3 class="h5">Rolling 30D volatility</h3>
              <div class="chart-card__canvas">
                <canvas id="tech100-performance-vol-chart" role="img" aria-label="TECH100 rolling volatility chart"></canvas>
              </div>
            </div>
          </div>

          <div class="tech100-performance__summary">
            <div class="kpi-card">
              <span class="kpi-label">Latest level</span>
              <span class="kpi-value">{{ kpis.level|floatformat:2 }}</span>
            </div>
            <div class="kpi-card">
              <span class="kpi-label">1D return</span>
              <span class="kpi-value">{{ kpis.ret_1d|default:"—"|floatformat:2 }}%</span>
            </div>
            <div class="kpi-card">
              <span class="kpi-label">MTD return</span>
              <span class="kpi-value">{{ kpis.ret_mtd|default:"—"|floatformat:2 }}%</span>
            </div>
            <div class="kpi-card">
              <span class="kpi-label">YTD return</span>
              <span class="kpi-value">{{ kpis.ret_ytd|default:"—"|floatformat:2 }}%</span>
            </div>
            <div class="kpi-card">
              <span class="kpi-label">30D vol (ann.)</span>
              <span class="kpi-value">{{ kpis.vol_30d|default:"—"|floatformat:2 }}%</span>
            </div>
            <div class="kpi-card">
              <span class="kpi-label">Max drawdown YTD</span>
              <span class="kpi-value">{{ kpis.drawdown_ytd|default:"—"|floatformat:2 }}%</span>
            </div>
          </div>

          <div class="tech100-performance__quality">
            <span class="muted">Data quality</span>
            <span class="pill pill--soft">REAL {{ quality_counts.REAL|default:0 }}</span>
            <span class="pill pill--soft pill--warning">IMPUTED {{ quality_counts.IMPUTED|default:0 }}</span>
          </div>
        </div>

        <div class="card tech100-performance__attribution" id="attribution">
          <div class="card__header card__header--split">
            <div>
              <h2 class="h4">Attribution</h2>
              <p class="muted">Top and bottom contributors by range.</p>
            </div>
            <div class="card__actions">
              <div class="tech100-performance__range">
                <button class="btn btn--ghost tech100-attr-range is-active" data-range="1d">1D</button>
                <button class="btn btn--ghost tech100-attr-range" data-range="mtd">MTD</button>
                <button class="btn btn--ghost tech100-attr-range" data-range="ytd">YTD</button>
              </div>
              <a class="btn btn--ghost btn--sm" href="/tech100/performance/export/?kind=attribution">Download CSV</a>
            </div>
          </div>
          <div id="tech100-attribution-status" data-tech100-attribution-has-data="1"></div>
          <div class="tech100-performance__bars">
            <div>
              <h3 class="h5">Top contributors</h3>
              <canvas id="tech100-top-contrib-chart" role="img" aria-label="Top contributors"></canvas>
            </div>
            <div>
              <h3 class="h5">Worst contributors</h3>
              <canvas id="tech100-worst-contrib-chart" role="img" aria-label="Worst contributors"></canvas>
            </div>
          </div>
          <div class="tech100-performance__filters">
            <input type="search" id="tech100-attr-search" placeholder="Search ticker or company">
            <label class="form-field form-field--toggle">
              <input type="checkbox" id="tech100-attr-imputed">
              <span>Show only IMPUTED</span>
            </label>
            <select id="tech100-attr-sector">
              <option value="">All sectors</option>
            </select>
          </div>
          <div class="table-wrapper table-wrap">
            <table class="table table--wide tech100-table" aria-label="TECH100 attribution">
              <thead>
                <tr>
                  <th class="text-left">Ticker</th>
                  <th class="text-left">Name</th>
                  <th class="text-right">Weight (%)</th>
                  <th class="text-right">1D Return (%)</th>
                  <th class="text-right">1D Contrib (bp)</th>
                  <th class="text-right">MTD Contrib (bp)</th>
                  <th class="text-right">YTD Contrib (bp)</th>
                  <th class="text-center">Quality</th>
                </tr>
              </thead>
              <tbody id="tech100-attr-body"></tbody>
            </table>
          </div>
        </div>

        <div class="card tech100-performance__holdings" id="holdings">
          <div class="card__header card__header--split">
            <div>
              <h2 class="h4">Constituents &amp; Holdings</h2>
              <p class="muted">Latest holdings from the index universe.</p>
            </div>
            <div class="card__actions">
              <a class="btn btn--ghost btn--sm" href="/tech100/performance/export/?kind=holdings">Download CSV</a>
            </div>
          </div>
          <div id="tech100-holdings-status" data-tech100-holdings-has-data="1"></div>
          <div class="tech100-performance__holdings-grid">
            <div class="chart-card">
              <h3 class="h5">Sector weights</h3>
              <canvas id="tech100-sector-chart" role="img" aria-label="Sector breakdown"></canvas>
            </div>
            <div class="chart-card">
              <h3 class="h5">Imputation history (30D)</h3>
              <table class="table table--compact" aria-label="Imputation history">
                <thead>
                  <tr>
                    <th class="text-left">Ticker</th>
                    <th class="text-right">Imputed days</th>
                    <th class="text-right">Last imputed</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in imputation_history %}
                    <tr>
                      <td class="text-left">{{ row.ticker }}</td>
                      <td class="text-right">{{ row.imputed_days }}</td>
                      <td class="text-right">{{ row.last_imputed|default:"—" }}</td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="3" class="text-center muted">No imputed observations.</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          <div class="table-wrapper table-wrap">
            <table class="table table--wide tech100-table" aria-label="TECH100 holdings">
              <thead>
                <tr>
                  <th class="text-left">Ticker</th>
                  <th class="text-left">Name</th>
                  <th class="text-left">Sector</th>
                  <th class="text-right">Weight (%)</th>
                  <th class="text-right">1D Return (%)</th>
                  <th class="text-right">1D Contrib (bp)</th>
                  <th class="text-center">Quality</th>
                </tr>
              </thead>
              <tbody id="tech100-holdings-body"></tbody>
            </table>
          </div>
        </div>
      {% endif %}
    </div>
  </section>
</div>

{{ levels_payload|json_script:"tech100-performance-levels" }}
{{ drawdown_payload|json_script:"tech100-performance-drawdown" }}
{{ vol_payload|json_script:"tech100-performance-vol" }}
{{ holdings|json_script:"tech100-performance-holdings" }}
{{ sector_breakdown|json_script:"tech100-performance-sectors" }}
{{ attribution_rows|json_script:"tech100-performance-attribution" }}
{{ top_1d|json_script:"tech100-performance-top-1d" }}
{{ worst_1d|json_script:"tech100-performance-worst-1d" }}
{{ top_mtd|json_script:"tech100-performance-top-mtd" }}
{{ worst_mtd|json_script:"tech100-performance-worst-mtd" }}
{{ top_ytd|json_script:"tech100-performance-top-ytd" }}
{{ worst_ytd|json_script:"tech100-performance-worst-ytd" }}
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/tech100-index.js' %}" defer></script>
{% endblock %}
