{% extends "base.html" %}
{% load static %}

{% block title %}TECH100 Index | SustainaCore{% endblock %}
{% block meta_description %}Explore TECH100 governance and ethics scores for leading technology firms, with filters, rankings, and transparency insights.{% endblock %}

{% block content %}
<div class="tech100-page">
<section class="section section--with-header">
  <div class="shell">
    <div class="section__header">
      <div>
        <span class="pill pill--soft">TECH100 AI Index</span>
        <h1>Governance scores</h1>
        <p class="muted">TECH100 ranking and filters.</p>
        <p class="disclaimer-banner">
          <a class="text-link" href="/tech100/methodology/">Methodology &amp; Limitations</a>
          <span class="disclaimer-banner__corrections"> · <a class="text-link" href="/corrections/">Corrections &amp; Complaints</a></span>
          · Research only. Not investment advice. Not affiliated with any company, exchange, or index provider.
        </p>
      </div>
    </div>

    {% include "partials/tech100_nav.html" %}

    {% if tech100_error %}
      <div class="alert alert--warning">
        Live TECH100 data is temporarily unavailable; please try again later.
      </div>
    {% endif %}

    <div class="card">
      <div class="card__header card__header--split">
        <div>
          <h2 class="h4">Tech100 AI Ethics &amp; Gov Index – Constituents</h2>
          <p class="muted" id="constituents-summary">
            {% if is_preview %}
              Showing {{ preview_limit }} of {{ total_count }} companies (preview). Verify your email to unlock the full list.
            {% else %}
              Showing {{ visible_count }} of {{ total_count }} companies.
            {% endif %}
          </p>
        </div>
      </div>
      <div class="tech100-filters-row">
        <form method="get" class="filters">
          <label>
            As-of date
            <select name="port_date">
              {% for d in port_date_options %}
                <option value="{{ d }}" {% if filters.port_date == d %}selected{% endif %}>{{ d }}</option>
              {% endfor %}
            </select>
          </label>

          <label>
            Sector
            <select name="sector">
              <option value="">All sectors</option>
              {% for s in sector_options %}
                <option value="{{ s }}" {% if filters.sector == s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </label>

          <label>
            Search
            <input
              type="search"
              name="q"
              placeholder="Search company or ticker"
              value="{{ filters.q|default:filters.search }}"
            >
          </label>

          <div class="filter__actions">
            <button type="submit" class="btn btn--secondary">Apply filters</button>
          </div>
        </form>

        {% url "tech100_export" as export_url %}
        <div class="filter__actions tech100-filters__download">
          {% with search_val=filters.q|default:filters.search %}
          <a
            class="btn btn--primary"
            href="{{ export_url }}?{% if filters.port_date %}port_date={{ filters.port_date|urlencode }}&{% endif %}{% if filters.sector %}sector={{ filters.sector|urlencode }}&{% endif %}{% if search_val %}q={{ search_val|urlencode }}&{% endif %}format=csv"
          >
            Download CSV
          </a>
          {% endwith %}
        </div>
      </div>

      <div class="table-wrapper table-wrap tech100-table-wrap">
          <table id="tech100-data" class="table table--wide tech100-table" aria-label="TECH100 index">
            <thead>
              <tr>
                <th class="text-center tech100-col--rank" scope="col">Rank</th>
                <th class="text-center" scope="col">Weight</th>
                <th class="text-left" scope="col">Company</th>
                <th class="text-center" scope="col">Transparency</th>
                <th class="text-center" scope="col">Ethical Principles</th>
                <th class="text-center" scope="col">Governance Structure</th>
                <th class="text-center" scope="col">Regulatory Alignment</th>
                <th class="text-center" scope="col">Stakeholder Engagement</th>
                <th class="text-center" scope="col">Composite AI Governance &amp; Ethics Score</th>
                <th class="text-center" scope="col">Details</th>
              </tr>
            </thead>
            <tbody>
              {% if companies %}
                {% for c in companies %}
                  <tr class="tech100-row">
                    <td class="text-center tech100-col--rank" data-order="{{ c.rank_index|default_if_none:'' }}">
                      {% if c.rank_index or c.rank_index == 0 %}
                        {{ c.rank_index|floatformat:0 }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="text-center" data-order="{{ c.weight|default_if_none:c.port_weight }}">
                      {% if c.weight_display_whole %}
                        {{ c.weight_display_whole }}
                      {% elif c.weight_display %}
                        {{ c.weight_display }}
                      {% elif c.weight or c.weight == 0 %}
                        {{ c.weight|floatformat:0 }}%
                      {% elif c.port_weight or c.port_weight == 0 %}
                        {{ c.port_weight|floatformat:0 }}%
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="text-left">
                      <div class="tech100-company">
                        <span class="tech100-company__name">{{ c.company_name|default:"—" }}</span>
                        {% if c.ticker %}
                          <span class="tech100-company__ticker">({{ c.ticker }})</span>
                        {% endif %}
                      </div>
                    </td>
                    <td class="text-center" data-order="{{ c.transparency|default_if_none:'' }}">
                      {% if c.transparency or c.transparency == 0 %}
                        {{ c.transparency|floatformat:1 }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="text-center" data-order="{{ c.ethical_principles|default_if_none:'' }}">
                      {% if c.ethical_principles or c.ethical_principles == 0 %}
                        {{ c.ethical_principles|floatformat:1 }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="text-center" data-order="{{ c.governance_structure|default_if_none:'' }}">
                      {% if c.governance_structure or c.governance_structure == 0 %}
                        {{ c.governance_structure|floatformat:1 }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="text-center" data-order="{{ c.regulatory_alignment|default_if_none:'' }}">
                      {% if c.regulatory_alignment or c.regulatory_alignment == 0 %}
                        {{ c.regulatory_alignment|floatformat:1 }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="text-center" data-order="{{ c.stakeholder_engagement|default_if_none:'' }}">
                      {% if c.stakeholder_engagement or c.stakeholder_engagement == 0 %}
                        {{ c.stakeholder_engagement|floatformat:1 }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="text-center" data-order="{{ c.aiges_composite|default_if_none:'' }}">
                      {% if c.aiges_composite or c.aiges_composite == 0 %}
                        {{ c.aiges_composite|floatformat:1 }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="text-center tech100-details-cell">
                      <button
                        type="button"
                        class="icon-button tech100-details-button"
                        data-template="tech100-detail-{{ forloop.counter0 }}"
                        data-company="{{ c.company_name|default:'Company' }}{% if c.ticker %} ({{ c.ticker }}){% endif %}"
                        aria-label="View details for {{ c.company_name|default:'Company' }}"
                      >
                        <span class="icon-button__icon" aria-hidden="true">↗</span>
                        <span class="sr-only">View Details</span>
                      </button>
                    </td>
                  </tr>
                  <template id="tech100-detail-{{ forloop.counter0 }}">
                    <div class="card card--lined tech100-details-card">
                      <div class="tech100-details__header">
                        <h3 class="h5 tech100-details__title">
                          {{ c.company_name|default:"Company" }}{% if c.ticker %} ({{ c.ticker }}){% endif %}
                        </h3>
                        <div class="muted">
                          Sector: {{ c.sector|default:c.gics_sector|default:"Not available" }}
                        </div>
                        {% if c.summary %}
                          <p class="tech100-summary">{{ c.summary }}</p>
                        {% else %}
                          <p class="tech100-summary muted">No summary available yet.</p>
                        {% endif %}
                      </div>

                      <div class="tech100-details__section">
                        <h4 class="h6">History</h4>
                        {% if c.history %}
                          <div class="tech100-history-wrapper">
                            <table class="table tech100-history-table" aria-label="Historical AIGES data for {{ c.company_name }}">
                              <thead>
                                <tr>
                                  <th>As-of date</th>
                                  <th class="text-right">Transparency</th>
                                  <th class="text-right">Ethical Principles</th>
                                  <th class="text-right">Governance Structure</th>
                                  <th class="text-right">Regulatory Alignment</th>
                                  <th class="text-right">Stakeholder Engagement</th>
                                  <th class="text-right">AIGES Composite</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for h in c.history %}
                                  <tr>
                                    <td><span data-date-format="as-of" data-date-value="{{ h.port_date_str }}">{{ h.port_date_str|default:"—" }}</span></td>
                                    <td class="text-right">
                                      {% if h.transparency or h.transparency == 0 %}
                                        {{ h.transparency|floatformat:1 }}
                                      {% else %}
                                        —
                                      {% endif %}
                                    </td>
                                    <td class="text-right">
                                      {% if h.ethical_principles or h.ethical_principles == 0 %}
                                        {{ h.ethical_principles|floatformat:1 }}
                                      {% else %}
                                        —
                                      {% endif %}
                                    </td>
                                    <td class="text-right">
                                      {% if h.governance_structure or h.governance_structure == 0 %}
                                        {{ h.governance_structure|floatformat:1 }}
                                      {% else %}
                                        —
                                      {% endif %}
                                    </td>
                                    <td class="text-right">
                                      {% if h.regulatory_alignment or h.regulatory_alignment == 0 %}
                                        {{ h.regulatory_alignment|floatformat:1 }}
                                      {% else %}
                                        —
                                      {% endif %}
                                    </td>
                                    <td class="text-right">
                                      {% if h.stakeholder_engagement or h.stakeholder_engagement == 0 %}
                                        {{ h.stakeholder_engagement|floatformat:1 }}
                                      {% else %}
                                        —
                                      {% endif %}
                                    </td>
                                    <td class="text-right">
                                      {% if h.aiges_composite or h.aiges_composite == 0 %}
                                        {{ h.aiges_composite|floatformat:1 }}
                                      {% else %}
                                        —
                                      {% endif %}
                                    </td>
                                  </tr>
                                {% endfor %}
            </tbody>
          </table>
        </div>
                          {% if c.history|length <= 1 %}
                            <p class="tech100-history-note muted">
                              Only the latest rebalance is available. Historical scores will appear as new rebalances are added.
                            </p>
                          {% endif %}
                        {% else %}
                          <p class="muted">Historical AIGES data not available yet.</p>
                        {% endif %}
                      </div>
                    </div>
                  </template>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="10" class="muted">Data currently unavailable.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
      </div>
      {% if is_preview %}
      <div class="constituents-locked" data-constituents-locked data-open-download-modal data-intent="unlock_table"
           data-next-url="{{ request.get_full_path }}"
           data-port-date="{{ filters.port_date }}"
           data-page="/tech100/"
           data-preview-limit="{{ preview_limit }}"
           data-sector="{{ filters.sector }}"
           data-q="{{ filters.q }}">
        <div class="constituents-locked__rows" aria-hidden="true">
          {% for _ in "1234567890" %}
          <div class="constituents-locked__row">
            <span class="constituents-locked__cell short"></span>
            <span class="constituents-locked__cell short"></span>
            <span class="constituents-locked__cell mid"></span>
            <span class="constituents-locked__cell long"></span>
            <span class="constituents-locked__cell mid"></span>
            <span class="constituents-locked__cell short"></span>
          </div>
          {% endfor %}
        </div>
        <div class="constituents-locked__cta">
          <button class="btn btn--primary" type="button">Verify email to view full list</button>
          <p class="muted">Free and unlimited access — we’ll email a 6-digit code.</p>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <div
    class="modal"
    id="tech100-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="tech100-modal-title"
    hidden
  >
    <div class="modal__dialog" role="document" tabindex="-1">
      <button type="button" class="modal__close" aria-label="Close details">×</button>
      <h3 class="modal__title" id="tech100-modal-title">Company details</h3>
      <div class="modal__body" id="tech100-modal-content"></div>
    </div>
  </div>
</section>
</div>
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/date-format.js' %}?v=20251221"></script>
  <script src="{% static 'js/tech100.js' %}?v=20251221"></script>
{% endblock %}
