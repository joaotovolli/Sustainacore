{% extends "base.html" %}

{% block title %}TECH100 Index | SustainaCore{% endblock %}

{% block content %}
<section class="section section--with-header">
    <div class="shell">
        <div class="section__header section__header--split">
            <div>
                <p class="eyebrow">TECH100 Index</p>
                <h1>Governance and ethics scores across leading technology firms.</h1>
                <p class="muted">Sortable, filterable indicators for transparency, accountability, and oversight. Data is fetched live from the SustainaCore backend.</p>
            </div>
            <div class="filters filters--stacked">
                <label>
                    Report date
                    <select id="port-date-filter">
                        <option value="">All dates</option>
                        {% for date in port_date_options %}
                        <option value="{{ date }}" {% if filters.port_date == date %}selected{% endif %}>{{ date }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    Sector
                    <select id="sector-filter">
                        <option value="">All sectors</option>
                        {% for sector in sector_options %}
                        <option value="{{ sector }}" {% if filters.sector == sector %}selected{% endif %}>{{ sector }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    Search
                    <input type="search" id="search-filter" placeholder="Search company or ticker" value="{{ filters.search }}" />
                </label>
                <div class="filter__actions">
                    <a class="btn btn--secondary" href="{% url 'tech100_export' %}?{% if filters.port_date %}port_date={{ filters.port_date|urlencode }}&{% endif %}{% if filters.sector %}sector={{ filters.sector|urlencode }}&{% endif %}{% if filters.search %}search={{ filters.search|urlencode }}&{% endif %}format=csv" data-export-csv>Download CSV</a>
                </div>
            </div>
        </div>
        {% if tech100_error %}
        <div class="alert alert--warning">Live TECH100 data is temporarily unavailable; please try again later.</div>
        {% endif %}
        <div class="card">
            <div class="card__header card__header--split">
                <div>
                    <h2 class="h4">TECH100 constituents</h2>
                    <p class="muted">Showing <span data-visible-count>{{ visible_count }}</span> of <span data-total-count>{{ total_count }}</span> companies.</p>
                </div>
                <div class="table-actions">
                    <span class="muted">Click headers to sort.</span>
                </div>
            </div>
            <div class="table table--wide" role="table" aria-label="TECH100 index">
                <div class="table__row table__row--head" role="row">
                    <button class="table__cell" role="columnheader" data-sort="port_date">Report date</button>
                    <button class="table__cell" role="columnheader" data-sort="rank_index">Rank</button>
                    <button class="table__cell" role="columnheader" data-sort="company_name">Company</button>
                    <button class="table__cell" role="columnheader" data-sort="ticker">Ticker</button>
                    <button class="table__cell" role="columnheader" data-sort="gics_sector">Sector</button>
                    <button class="table__cell table__cell--right" role="columnheader" data-sort="port_weight">Weight</button>
                    <button class="table__cell table__cell--right" role="columnheader" data-sort="transparency">Transparency</button>
                    <button class="table__cell table__cell--right" role="columnheader" data-sort="ethical_principles">Ethical principles</button>
                    <button class="table__cell table__cell--right" role="columnheader" data-sort="governance_structure">Governance structure</button>
                    <button class="table__cell table__cell--right" role="columnheader" data-sort="regulatory_alignment">Regulatory alignment</button>
                    <button class="table__cell table__cell--right" role="columnheader" data-sort="stakeholder_engagement">Stakeholder engagement</button>
                    <button class="table__cell table__cell--right" role="columnheader" data-sort="aiges_composite_average">AIGES Composite</button>
                    <div class="table__cell" role="columnheader">Summary</div>
                </div>
                <div data-tech100-body>
                    {% if companies %}
                        {% for company in companies %}
                        <div class="table__row" role="row">
                            <div class="table__cell" role="cell">{{ company.port_date }}</div>
                            <div class="table__cell" role="cell">{{ company.rank_index }}</div>
                            <div class="table__cell" role="cell">{{ company.company_name }}</div>
                            <div class="table__cell" role="cell">{{ company.ticker }}</div>
                            <div class="table__cell" role="cell">{{ company.gics_sector }}</div>
                            <div class="table__cell table__cell--right" role="cell">{{ company.port_weight }}</div>
                            <div class="table__cell table__cell--right" role="cell">{{ company.transparency }}</div>
                            <div class="table__cell table__cell--right" role="cell">{{ company.ethical_principles }}</div>
                            <div class="table__cell table__cell--right" role="cell">{{ company.governance_structure }}</div>
                            <div class="table__cell table__cell--right" role="cell">{{ company.regulatory_alignment }}</div>
                            <div class="table__cell table__cell--right" role="cell">{{ company.stakeholder_engagement }}</div>
                            <div class="table__cell table__cell--right" role="cell">{{ company.aiges_composite_average }}</div>
                            <div class="table__cell" role="cell">{{ company.summary|truncatechars:120 }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="table__row" role="row">
                            <div class="table__cell" role="cell" colspan="13">Data currently unavailable.</div>
                        </div>
                    {% endif %}
                </div>
            </div>
            <p class="muted table__note">Sorted and filtered locally using data retrieved from the VM1 /api/tech100 endpoint.</p>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
{{ all_companies|default:companies|json_script:"tech100-data" }}
<script>
(function() {
    const body = document.querySelector('[data-tech100-body]');
    const datasetScript = document.getElementById('tech100-data');
    const data = datasetScript ? JSON.parse(datasetScript.textContent) : [];
    const searchInput = document.getElementById('search-filter');
    const portDateSelect = document.getElementById('port-date-filter');
    const sectorSelect = document.getElementById('sector-filter');
    const visibleCount = document.querySelector('[data-visible-count]');
    const totalCount = document.querySelector('[data-total-count]');
    const csvButton = document.querySelector('[data-export-csv]');

    const filters = {
        port_date: portDateSelect ? portDateSelect.value : '',
        sector: sectorSelect ? sectorSelect.value : '',
        search: searchInput ? searchInput.value : '',
    };

    function formatPercent(value) {
        if (value === null || value === undefined || value === '') return '—';
        const num = Number(value);
        if (Number.isNaN(num)) return value;
        return `${num.toFixed(num >= 10 ? 1 : 2)}%`;
    }

    function formatNumber(value) {
        if (value === null || value === undefined || value === '') return '—';
        const num = Number(value);
        if (Number.isNaN(num)) return value;
        return num.toFixed(2);
    }

    function formatDate(value) {
        if (!value) return '—';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function truncate(text, max = 200) {
        if (!text) return '';
        return text.length > max ? `${text.slice(0, max)}…` : text;
    }

    function buildSummaryModal() {
        let modal = document.getElementById('summary-modal');
        if (modal) return modal;
        modal = document.createElement('div');
        modal.id = 'summary-modal';
        modal.innerHTML = `
            <div class="modal__backdrop" data-modal-close></div>
            <div class="modal">
                <div class="modal__header">
                    <h3 data-modal-title>Summary</h3>
                    <button class="modal__close" data-modal-close aria-label="Close">×</button>
                </div>
                <div class="modal__body">
                    <p data-modal-body></p>
                    <div data-modal-links class="modal__links"></div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (event) => {
            if (event.target.matches('[data-modal-close]')) {
                modal.classList.remove('is-open');
            }
        });
        return modal;
    }

    const modal = buildSummaryModal();
    const modalTitle = modal.querySelector('[data-modal-title]');
    const modalBody = modal.querySelector('[data-modal-body]');
    const modalLinks = modal.querySelector('[data-modal-links]');

    function openSummary(item) {
        modalTitle.textContent = item.company_name || item.company || 'Summary';
        modalBody.textContent = item.summary || 'No summary available.';
        modalLinks.innerHTML = '';
        const links = (item.source_links || '').split(/[|,]/).map((l) => l.trim()).filter(Boolean);
        if (links.length) {
            const heading = document.createElement('p');
            heading.className = 'muted';
            heading.textContent = 'Sources';
            modalLinks.appendChild(heading);
            const list = document.createElement('ul');
            links.forEach((link) => {
                const li = document.createElement('li');
                const anchor = document.createElement('a');
                anchor.href = link;
                anchor.target = '_blank';
                anchor.rel = 'noopener noreferrer';
                anchor.textContent = link;
                li.appendChild(anchor);
                list.appendChild(li);
            });
            modalLinks.appendChild(list);
        }
        modal.classList.add('is-open');
    }

    function setCounts(visible, total) {
        if (visibleCount) visibleCount.textContent = visible;
        if (totalCount) totalCount.textContent = total;
    }

    function filterData() {
        const searchTerm = filters.search.toLowerCase();
        return data.filter((item) => {
            if (filters.port_date && (item.port_date || '').toString() !== filters.port_date) return false;
            const sectorValue = item.gics_sector || item.sector || '';
            if (filters.sector && sectorValue !== filters.sector) return false;
            if (searchTerm) {
                const name = (item.company_name || item.company || '').toLowerCase();
                const ticker = (item.ticker || '').toLowerCase();
                if (!name.includes(searchTerm) && !ticker.includes(searchTerm)) return false;
            }
            return true;
        });
    }

    const sortState = { key: null, direction: 'asc' };

    function sortData(rows) {
        if (!sortState.key) return rows;
        const direction = sortState.direction === 'asc' ? 1 : -1;
        return [...rows].sort((a, b) => {
            const aVal = a[sortState.key];
            const bVal = b[sortState.key];
            const aNum = Number(aVal);
            const bNum = Number(bVal);
            if (!Number.isNaN(aNum) && !Number.isNaN(bNum)) {
                return (aNum - bNum) * direction;
            }
            return String(aVal || '').localeCompare(String(bVal || '')) * direction;
        });
    }

    function render(rows) {
        body.innerHTML = '';
        const filtered = sortData(rows);
        if (!filtered.length) {
            const row = document.createElement('div');
            row.className = 'table__row';
            row.setAttribute('role', 'row');
            row.innerHTML = `<div class="table__cell" role="cell" colspan="13">Data currently unavailable.</div>`;
            body.appendChild(row);
            setCounts(0, data.length);
            return;
        }

        filtered.forEach((item) => {
            const row = document.createElement('div');
            row.className = 'table__row';
            row.setAttribute('role', 'row');
            const summary = item.summary || '';
            const truncated = truncate(summary, 200);
            const hasLongSummary = summary && summary.length > 200;
            row.innerHTML = `
                <div class="table__cell" role="cell">${formatDate(item.port_date)}</div>
                <div class="table__cell" role="cell">${item.rank_index ?? '—'}</div>
                <div class="table__cell" role="cell">${item.company_name || item.company || '—'}</div>
                <div class="table__cell" role="cell">${item.ticker || '—'}</div>
                <div class="table__cell" role="cell">${item.gics_sector || item.sector || '—'}</div>
                <div class="table__cell table__cell--right" role="cell">${formatPercent(item.port_weight)}</div>
                <div class="table__cell table__cell--right" role="cell">${formatNumber(item.transparency)}</div>
                <div class="table__cell table__cell--right" role="cell">${formatNumber(item.ethical_principles)}</div>
                <div class="table__cell table__cell--right" role="cell">${formatNumber(item.governance_structure)}</div>
                <div class="table__cell table__cell--right" role="cell">${formatNumber(item.regulatory_alignment)}</div>
                <div class="table__cell table__cell--right" role="cell">${formatNumber(item.stakeholder_engagement)}</div>
                <div class="table__cell table__cell--right" role="cell">${formatNumber(item.aiges_composite_average)}</div>
                <div class="table__cell" role="cell">
                    <div class="summary__text">${truncated || '—'}</div>
                    ${hasLongSummary ? '<button class="btn btn--text" data-summary>View more</button>' : ''}
                </div>
            `;
            if (hasLongSummary) {
                const btn = row.querySelector('[data-summary]');
                btn.addEventListener('click', () => openSummary(item));
            }
            body.appendChild(row);
        });

        setCounts(filtered.length, data.length);
    }

    function updateExportLink() {
        if (!csvButton) return;
        const params = new URLSearchParams();
        if (filters.port_date) params.append('port_date', filters.port_date);
        if (filters.sector) params.append('sector', filters.sector);
        if (filters.search) params.append('search', filters.search);
        params.append('format', 'csv');
        const base = csvButton.getAttribute('href').split('?')[0];
        csvButton.href = `${base}?${params.toString()}`;
    }

    function handleFilterChange() {
        const filtered = filterData();
        render(filtered);
        updateExportLink();
    }

    document.querySelectorAll('[data-sort]').forEach((btn) => {
        btn.addEventListener('click', () => {
            const key = btn.dataset.sort;
            if (sortState.key === key) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.key = key;
                sortState.direction = 'asc';
            }
            handleFilterChange();
        });
    });

    if (portDateSelect) {
        portDateSelect.addEventListener('change', (event) => {
            filters.port_date = event.target.value;
            handleFilterChange();
        });
    }

    if (sectorSelect) {
        sectorSelect.addEventListener('change', (event) => {
            filters.sector = event.target.value;
            handleFilterChange();
        });
    }

    if (searchInput) {
        searchInput.addEventListener('input', (event) => {
            filters.search = event.target.value.trim();
            handleFilterChange();
        });
    }

    render(filterData());
    updateExportLink();
})();
</script>
<style>
.filters--stacked {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    align-items: end;
}

.filters--stacked .filter__actions {
    display: flex;
    justify-content: flex-end;
    align-items: center;
}

.table--wide {
    overflow-x: auto;
}

.table--wide .table__row {
    min-width: 1200px;
}

.summary__text {
    max-width: 320px;
}

.modal__backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
}

.modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    padding: 20px;
    max-width: 720px;
    width: calc(100% - 40px);
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 20;
}

#summary-modal {
    display: none;
}

#summary-modal.is-open {
    display: block;
}

.modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}

.modal__close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}

.modal__links ul {
    margin: 8px 0 0;
    padding-left: 18px;
}

.btn--text {
    background: none;
    color: #0055cc;
    padding: 0;
    border: none;
    font-weight: 600;
    cursor: pointer;
}
</style>
{% endblock %}
