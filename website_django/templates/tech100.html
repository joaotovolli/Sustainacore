{% extends "base.html" %}

{% block title %}TECH100 Index | SustainaCore{% endblock %}

{% block content %}
<section class="section section--with-header">
  <div class="shell">
    <div class="section__header section__header--split">
      <div>
        <p class="eyebrow">TECH100 Index</p>
        <h1>Governance and ethics scores across leading technology firms.</h1>
        <p class="muted">
          Sortable, filterable indicators for transparency, accountability, and oversight.
          Data is fetched live from the SustainaCore backend.
        </p>
      </div>

      <div>
        <form method="get" class="filters filters--stacked">
          <label>
            Report date
            <select name="port_date">
              <option value="">All dates</option>
              {% for d in port_date_options %}
                <option value="{{ d }}" {% if filters.port_date == d %}selected{% endif %}>{{ d }}</option>
              {% endfor %}
            </select>
          </label>

          <label>
            Sector
            <select name="sector">
              <option value="">All sectors</option>
              {% for s in sector_options %}
                <option value="{{ s }}" {% if filters.sector == s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </label>

          <label>
            Search
            <input
              type="search"
              name="q"
              placeholder="Search company or ticker"
              value="{{ filters.q|default:filters.search }}"
            >
          </label>

          <div class="filter__actions">
            <button type="submit" class="btn btn--secondary">Apply filters</button>
          </div>
        </form>

        {% url "tech100_export" as export_url %}
        <div class="filter__actions" style="margin-top: 0.75rem;">
          {% with search_val=filters.q|default:filters.search %}
          <a
            class="btn btn--primary"
            href="{{ export_url }}?{% if filters.port_date %}port_date={{ filters.port_date|urlencode }}&{% endif %}{% if filters.sector %}sector={{ filters.sector|urlencode }}&{% endif %}{% if search_val %}q={{ search_val|urlencode }}&{% endif %}format=csv"
          >
            Download CSV
          </a>
          {% endwith %}
        </div>
      </div>
    </div>

    {% if tech100_error %}
      <div class="alert alert--warning">
        Live TECH100 data is temporarily unavailable; please try again later.
      </div>
    {% endif %}

    <div class="card">
      <div class="card__header card__header--split">
        <div>
          <h2 class="h4">TECH100 constituents</h2>
          <p class="muted">
            Showing {{ visible_count }} of {{ total_count }} companies.
          </p>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="tech100-data" class="table table--wide" aria-label="TECH100 index">
          <thead>
            <tr>
              <th>Port Date</th>
              <th class="text-right">Rank Index</th>
              <th>Company</th>
              <th class="text-right">AIGES Composite</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% if companies %}
              {% for c in companies %}
                <tr>
                  <td>{{ c.port_date|default:"—" }}</td>
                  <td class="text-right">{{ c.rank_index|default:"—" }}</td>
                  <td>
                    <div>
                      <div style="font-weight: 700;">
                        {{ c.company_name|default:"—" }}
                        {% if c.ticker %}<span class="muted" style="font-weight: 500;">({{ c.ticker }})</span>{% endif %}
                      </div>
                    </div>
                  </td>
                  <td class="text-right">
                    {% if c.aiges_composite_average or c.aiges_composite_average == 0 %}
                      {{ c.aiges_composite_average|floatformat:1 }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    <details class="tech100-details">
                      <summary class="text-link">View details</summary>
                      <div class="card card--lined tech100-details__panel" style="margin-top: 0.5rem;">
                        <div style="margin-bottom: 0.75rem;">
                          <div style="margin-bottom: 0.35rem;">
                            <strong>{{ c.company_name|default:"Company" }}</strong>
                            {% if c.ticker %}
                              <div class="muted">{{ c.ticker }}</div>
                            {% endif %}
                          </div>
                          {% if c.gics_sector or c.sector %}
                            <div class="muted" style="margin-bottom: 0.35rem;">
                              Sector: {{ c.gics_sector|default:c.sector }}
                            </div>
                          {% endif %}
                          {% if c.summary %}
                            <p style="margin: 0;">{{ c.summary }}</p>
                          {% else %}
                            <p class="muted" style="margin: 0;">No summary available yet.</p>
                          {% endif %}
                        </div>

                        {% with history=c.history %}
                          <div class="table-wrapper">
                            <table class="table table--wide" aria-label="Historical AIGES data for {{ c.company_name }}">
                              <thead>
                                <tr>
                                  <th>Port Date</th>
                                  <th class="text-right">Transparency</th>
                                  <th class="text-right">Ethical Principles</th>
                                  <th class="text-right">Governance Structure</th>
                                  <th class="text-right">Regulatory Alignment</th>
                                  <th class="text-right">Stakeholder Engagement</th>
                                  <th class="text-right">AIGES Composite</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% if history %}
                                  {% for h in history %}
                                    <tr>
                                      <td>{{ h.port_date|default:"—" }}</td>
                                      <td class="text-right">
                                        {% if h.transparency or h.transparency == 0 %}
                                          {{ h.transparency|floatformat:1 }}
                                        {% endif %}
                                      </td>
                                      <td class="text-right">
                                        {% if h.ethical_principles or h.ethical_principles == 0 %}
                                          {{ h.ethical_principles|floatformat:1 }}
                                        {% endif %}
                                      </td>
                                      <td class="text-right">
                                        {% if h.governance_structure or h.governance_structure == 0 %}
                                          {{ h.governance_structure|floatformat:1 }}
                                        {% endif %}
                                      </td>
                                      <td class="text-right">
                                        {% if h.regulatory_alignment or h.regulatory_alignment == 0 %}
                                          {{ h.regulatory_alignment|floatformat:1 }}
                                        {% endif %}
                                      </td>
                                      <td class="text-right">
                                        {% if h.stakeholder_engagement or h.stakeholder_engagement == 0 %}
                                          {{ h.stakeholder_engagement|floatformat:1 }}
                                        {% endif %}
                                      </td>
                                      <td class="text-right">
                                        {% if h.aiges_composite_average or h.aiges_composite_average == 0 %}
                                          {{ h.aiges_composite_average|floatformat:1 }}
                                        {% endif %}
                                      </td>
                                    </tr>
                                  {% endfor %}
                                {% else %}
                                  <tr>
                                    <td colspan="7" class="muted">Historical AIGES data not available yet.</td>
                                  </tr>
                                {% endif %}
                              </tbody>
                            </table>
                          </div>
                        {% endwith %}
                      </div>
                    </details>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="muted">Data currently unavailable.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}{% endblock %}
