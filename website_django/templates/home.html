{% extends "base.html" %}
{% load static %}

{% block title %}SustainaCore | Open ESG & AI governance{% endblock %}
{% block meta_description %}Open ESG and AI governance data with TECH100 scores, curated news, and the Ask2 assistant from SustainaCore.{% endblock %}

{% block extra_head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <link rel="stylesheet" href="{% static 'css/ai_reg.css' %}?v={{ static_version }}">
{% endblock %}

{% block content %}
<section class="hero hero--revamp">
    <div class="shell hero__grid">
        <div class="hero__copy">
            <p class="eyebrow">Open AI governance intelligence</p>
            <h1>Evidence-ready signals for responsible technology.</h1>
            <p class="lead">SustainaCore combines transparent data, reproducible indicators, and human context so teams can evaluate how technology companies govern AI responsibly.</p>
            <div class="actions">
                <a class="btn btn--primary" href="/tech100/index/">Explore the index</a>
                <a class="btn btn--ghost" href="{% url 'ask2:ask2_page' %}" aria-label="Talk to our Ask2 AI Assistant">Talk to Ask2</a>
            </div>
            <ul class="hero__bullets">
                <li>Compare companies on transparency, accountability, and oversight.</li>
                <li>Monitor regulatory signals across jurisdictions.</li>
                <li>Ask questions in plain language with grounded answers.</li>
            </ul>
        </div>
        <div class="home-launchpad">
            <div class="launch-card">
                <span class="launch-card__icon">üìà</span>
                <h3 class="h5">AI Governance Index</h3>
                <p class="muted">Performance, constituents, attribution, and governance scores.</p>
                <a class="text-link" href="/tech100/index/">Index overview ‚Üí</a>
            </div>
            <div class="launch-card">
                <span class="launch-card__icon">üí¨</span>
                <h3 class="h5">Ask2 AI Chat</h3>
                <p class="muted">Ask questions in natural language with cited answers.</p>
                <a class="text-link" href="{% url 'ask2:ask2_page' %}">Open Ask2 ‚Üí</a>
            </div>
            <div class="launch-card">
                <span class="launch-card__icon">üåê</span>
                <h3 class="h5">Regulatory Heat Map</h3>
                <p class="muted">Explore AI policy coverage and jurisdiction detail.</p>
                <a class="text-link" href="/ai-regulation/">View the globe ‚Üí</a>
            </div>
            <div class="launch-card">
                <span class="launch-card__icon">üì∞</span>
                <h3 class="h5">News &amp; insights</h3>
                <p class="muted">Curated governance headlines and evidence updates.</p>
                <a class="text-link" href="{% url 'news' %}">Browse news ‚Üí</a>
            </div>
        </div>
    </div>
</section>

<section class="section tech100-home">
    <div class="shell">
        <div class="section__header section__header--split">
            <div>
                <span class="pill pill--soft">TECH100 Index Snapshot</span>
                <h2>Performance at a glance</h2>
                <p class="muted">A compact view of index performance and risk signals.</p>
            </div>
        </div>

        {% if tech100_snapshot.data_error %}
            <div class="alert alert--warning" data-tech100-home-empty="1">
                Live TECH100 data is temporarily unavailable; please try again later.
            </div>
        {% elif tech100_snapshot.has_data %}
        <div class="tech100-home__grid"
                 data-tech100-home-has-data="1"
                 data-level-count="{{ tech100_snapshot.levels_count }}"
                 data-real-count="{{ tech100_snapshot.quality_counts.REAL|default:0 }}"
                 data-imputed-count="{{ tech100_snapshot.quality_counts.IMPUTED|default:0 }}">
                <div class="card tech100-home__chart">
                    <div class="tech100-home__chart-header">
                        <div>
                            <h3 class="h4">Tech100 AI Ethics &amp; Gov Index</h3>
                            <p class="muted tech100-home__as-of">As of <span data-date-format="as-of" data-date-value="{{ tech100_snapshot.as_of }}">{{ tech100_snapshot.as_of }}</span></p>
                        </div>
                        <div class="tech100-index__range tech100-home__range">
                            <button class="btn btn--ghost tech100-home-range" data-range="1m">1M</button>
                            <button class="btn btn--ghost tech100-home-range is-active" data-range="3m">3M</button>
                            <button class="btn btn--ghost tech100-home-range" data-range="6m">6M</button>
                            <button class="btn btn--ghost tech100-home-range" data-range="ytd">YTD</button>
                            <button class="btn btn--ghost tech100-home-range" data-range="1y">1Y</button>
                            <button class="btn btn--ghost tech100-home-range" data-range="max">Max</button>
                        </div>
                    </div>
                    <div class="tech100-home__canvas">
                        <canvas id="tech100-home-level-chart" role="img" aria-label="TECH100 index level chart"></canvas>
                    </div>
                    <div class="tech100-home__stats-grid">
                        <div>
                            <p class="kpi-label">Latest level</p>
                            <p class="kpi-value">{{ tech100_snapshot.latest_level_display|default:"‚Äî" }}</p>
                        </div>
                        <div>
                            <p class="kpi-label">1D return</p>
                            <p class="kpi-value">{{ tech100_snapshot.ret_1d_display|default:"‚Äî" }}</p>
                        </div>
                        <div>
                            <p class="kpi-label">MTD return</p>
                            <p class="kpi-value">{{ tech100_snapshot.ret_mtd_display|default:"‚Äî" }}</p>
                        </div>
                        <div>
                            <p class="kpi-label">YTD return</p>
                            <p class="kpi-value">{{ tech100_snapshot.ret_ytd_display|default:"‚Äî" }}</p>
                        </div>
                    </div>
                    <div class="tech100-home__facts">
                        <div class="tech100-home__fact">
                            <p class="kpi-label">30D volatility</p>
                            <p class="kpi-value">{{ tech100_snapshot.vol_30d_display|default:"‚Äî" }}</p>
                        </div>
                        <div class="tech100-home__fact">
                            <p class="kpi-label">YTD drawdown</p>
                            <p class="kpi-value">{{ tech100_snapshot.drawdown_ytd_display|default:"‚Äî" }}</p>
                        </div>
                        <div class="tech100-home__fact">
                            <p class="kpi-label">Data points</p>
                            <p class="kpi-value">{{ tech100_snapshot.quality_counts.REAL|default:0 }}</p>
                        </div>
                    </div>
                </div>
                <div class="card tech100-home__attribution" data-attribution-panel>
                    <div class="tech100-home__attribution-header">
                        <div>
                            <h3 class="h4">Attribution snapshot</h3>
                            <p class="muted">A compact view of contributors by timeframe.</p>
                        </div>
                        <div class="tech100-home__attribution-controls" role="tablist" aria-label="Attribution timeframe">
                            <button class="btn btn--ghost btn--sm is-active" type="button" role="tab" aria-selected="true" data-attr-range="1d">1D</button>
                            <button class="btn btn--ghost btn--sm" type="button" role="tab" aria-selected="false" data-attr-range="mtd">MTD</button>
                            <button class="btn btn--ghost btn--sm" type="button" role="tab" aria-selected="false" data-attr-range="ytd">YTD</button>
                            <a class="btn btn--ghost btn--sm" href="/tech100/performance/export/?kind=attribution">Download CSV</a>
                        </div>
                    </div>
                    <div class="tech100-home__attribution-grid">
                        <div>
                            <h4 class="h6">Top contributors</h4>
                            <canvas id="tech100-home-top-chart" role="img" aria-label="Top contributors"></canvas>
                        </div>
                        <div>
                            <h4 class="h6">Worst contributors</h4>
                            <canvas id="tech100-home-worst-chart" role="img" aria-label="Worst contributors"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert--warning" data-tech100-home-empty="1">
                No TECH100 index data found.
            </div>
        {% endif %}
    </div>
</section>

<section class="section section--alt ai-reg-home">
    <div class="shell">
        <div class="section__header section__header--split">
            <div>
                <h2>AI Regulatory Heat Map</h2>
                <p class="muted">Explore where AI rules are accelerating, then drill into a jurisdiction to see instruments, milestones, and sources.</p>
            </div>
            <a class="text-link" href="/ai-regulation/">Open AI Regulation ‚Üí</a>
        </div>
        <div
            class="card ai-reg__card ai-reg__card--home"
            data-ai-reg-root
            data-default-iso="US"
            data-heatmap-endpoint="/ai-regulation/data/heatmap"
            data-jurisdiction-endpoint="/ai-regulation/data/jurisdiction"
            data-geojson-url="{% static 'geo/world_countries_simplified.geojson' %}"
            data-globe-texture-url="{% static 'geo/earth_texture.svg' %}"
        >
            <div class="card__header card__header--split">
                <div>
                    <h3 class="h5">Global snapshot</h3>
                    <p class="muted">Drag to rotate ‚Ä¢ Click a country for details.</p>
                </div>
                <div class="card__actions ai-reg__filters">
                    <label>
                        As-of date
                        <select name="as_of" id="ai-reg-as-of" data-endpoint="/ai-regulation/data/as-of-dates">
                            {% if as_of_dates %}
                              {% for d in as_of_dates %}
                                <option value="{{ d }}" {% if d == latest_as_of %}selected{% endif %}>{{ d }}</option>
                              {% endfor %}
                            {% else %}
                              <option value="">No snapshots available</option>
                            {% endif %}
                        </select>
                    </label>
                    <label>
                        Country
                        <select name="country" data-country-select disabled>
                            <option value="">Loading countries‚Ä¶</option>
                        </select>
                    </label>
                </div>
            </div>
            <div class="ai-reg__grid">
                <div class="card card--lined ai-reg__map">
                    <div class="card__header">
                        <div class="ai-reg__summary">
                            <div>
                                <span class="muted">Jurisdictions</span>
                                <strong data-ai-reg-summary-jurisdictions>--</strong>
                            </div>
                            <div>
                                <span class="muted">Instruments</span>
                                <strong data-ai-reg-summary-instruments>--</strong>
                            </div>
                        </div>
                    </div>
                    <div class="ai-reg__map-shell" data-map-container>
                        <div class="ai-reg__globe" data-globe></div>
                        <div class="ai-reg__fallback" data-fallback hidden>
                            <div class="ai-reg__fallback-label" data-fallback-label>2D fallback map (WebGL unavailable)</div>
                        </div>
                        <div class="ai-reg__tooltip" data-tooltip hidden></div>
                        <div class="ai-reg__loading" data-map-loading hidden>Loading heatmap‚Ä¶</div>
                        <div class="ai-reg__error" data-map-error hidden></div>
                    </div>
                    <div class="ai-reg__legend">
                        <span class="muted">Low</span>
                        <div class="ai-reg__legend-bar" aria-hidden="true"></div>
                        <span class="muted">High</span>
                        <div class="ai-reg__controls">
                            <button type="button" class="btn btn--ghost btn--sm" data-zoom-in>Zoom in</button>
                            <button type="button" class="btn btn--ghost btn--sm" data-zoom-out>Zoom out</button>
                            <button type="button" class="btn btn--ghost btn--sm ai-reg__reset" data-reset-view>Reset</button>
                        </div>
                    </div>
                </div>
                <aside class="card card--lined ai-reg__panel" data-drilldown-panel>
                    <div class="card__header">
                        <div>
                            <h3 class="h5">Jurisdiction preview</h3>
                            <p class="muted">Default: United States. Click another country to update.</p>
                        </div>
                    </div>
                    <div class="ai-reg__panel-body" data-drilldown-body>
                        <div class="muted">Loading jurisdiction detail‚Ä¶</div>
                    </div>
                </aside>
            </div>
            <div class="ai-reg__lists" data-ai-reg-lists></div>
        </div>
    </div>
</section>

<section class="section">
    <div class="shell">
        <div class="section__header section__header--split">
            <div>
                <h2>Latest from Tech100 AI Ethics &amp; Gov Index</h2>
                <p class="muted">A snapshot of company scores before you dive into the full index.</p>
            </div>
            <a class="text-link" href="{% url 'tech100' %}">Open TECH100 ‚Üí</a>
        </div>
        <div class="table-wrapper">
            <div class="table tech100-home-table" role="table" aria-label="TECH100 preview">
                <div class="table__row table__row--head" role="row">
                    <div class="table__cell" role="columnheader">Company</div>
                    <div class="table__cell" role="columnheader">Sector</div>
                    <div class="table__cell table__cell--right" role="columnheader">Transparency</div>
                    <div class="table__cell table__cell--right" role="columnheader">Ethical Principles</div>
                    <div class="table__cell table__cell--right" role="columnheader">Governance Structure</div>
                    <div class="table__cell table__cell--right" role="columnheader">Regulatory Alignment</div>
                    <div class="table__cell table__cell--right" role="columnheader">Stakeholder Engagement</div>
                    <div class="table__cell table__cell--right" role="columnheader">Composite AI Gov &amp; Ethics</div>
                </div>
                {% for company in tech100_preview %}
                <div class="table__row" role="row">
                    <div class="table__cell" role="cell">{{ company.company_display|default:company.company }}</div>
                    <div class="table__cell" role="cell">{{ company.sector }}</div>
                    <div class="table__cell table__cell--right" role="cell">{{ company.transparency|default:"‚Äî" }}</div>
                    <div class="table__cell table__cell--right" role="cell">{{ company.ethical_principles|default:"‚Äî" }}</div>
                    <div class="table__cell table__cell--right" role="cell">{{ company.governance_structure|default:"‚Äî" }}</div>
                    <div class="table__cell table__cell--right" role="cell">{{ company.regulatory_alignment|default:"‚Äî" }}</div>
                    <div class="table__cell table__cell--right" role="cell">{{ company.stakeholder_engagement|default:"‚Äî" }}</div>
                    <div class="table__cell table__cell--right" role="cell">
                        <span class="badge">{{ company.composite|default:"‚Äî" }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<section class="section section--alt">
    <div class="shell">
        <div class="section__header section__header--split">
            <div>
                <h2>News &amp; insights</h2>
                <p class="muted">Curated headlines on AI governance, ESG transparency, and regulatory moves.</p>
            </div>
            <a class="text-link" href="{% url 'news' %}">See all news ‚Üí</a>
        </div>
        <div class="news-grid">
            {% if news_preview %}
                {% for item in news_preview %}
                <article class="news-card">
                    {% if item.detail_url %}
                    <a class="news-card__link" href="{{ item.detail_url }}"{% if item.external %} target="_blank" rel="noopener noreferrer"{% endif %}>
                    {% endif %}
                        <div class="news-card__meta">{{ item.source }}{% if item.published_at %} ¬∑ {{ item.published_at|date:"M j, Y" }}{% endif %}</div>
                        <h3 class="news-card__title">{{ item.title }}</h3>
                        <p class="muted home-news__snippet">{{ item.snippet }}</p>
                        <span class="news-card__cta">Open article ‚Üí</span>
                    {% if item.detail_url %}
                    </a>
                    {% endif %}
                </article>
                {% endfor %}
            {% else %}
                <article class="news-card news-card--empty">
                    <p class="muted">No news items are available right now.</p>
                    <a class="text-link" href="{% url 'news' %}">More news ‚Üí</a>
                </article>
            {% endif %}
        </div>
        {% if news_preview|length < 3 %}
        <div class="load-more">
            <a class="btn btn--secondary" href="{% url 'news' %}">More news ‚Üí</a>
        </div>
        {% endif %}
    </div>
</section>


<section class="section">
    <div class="shell">
        <div class="section__header">
            <h2>What you can do with SustainaCore</h2>
            <p class="muted">Start with a clear overview, then dive into structured scores, curated news, and a guided assistant.</p>
        </div>
        <div class="cards cards--three">
            <div class="card">
                <div class="card__icon">üìä</div>
                <p class="pill pill--soft">TECH100</p>
                <h3>Governance &amp; ethics index</h3>
                <p class="muted">Sortable, comparable scores across transparency, accountability, and oversight pillars.</p>
                <a class="btn btn--secondary" href="{% url 'tech100' %}">Open TECH100</a>
            </div>
            <div class="card">
                <div class="card__icon">üí°</div>
                <p class="pill pill--soft">Ask2</p>
                <h3>AI assistant with evidence</h3>
                <p class="muted">Ask questions in natural language and get grounded answers sourced from the SustainaCore backend.</p>
                <a class="btn btn--secondary" href="{% url 'ask2:ask2_page' %}" aria-label="Chat with the Ask2 AI Assistant">Chat with Ask2</a>
            </div>
            <div class="card">
                <div class="card__icon">üóûÔ∏è</div>
                <p class="pill pill--soft">News</p>
                <h3>AI governance headlines</h3>
                <p class="muted">Stay current on regulatory updates, transparency reports, and accountability signals.</p>
                <a class="btn btn--secondary" href="{% url 'news' %}">Browse news</a>
            </div>
        </div>
    </div>

</section>

<section class="section section--alt">
    <div class="shell">
        <div class="section__header">
            <h2>Methodology you can trust</h2>
            <p class="muted">Structured around public evidence, transparent scoring, and reproducible workflows.</p>
        </div>
        <div class="grid grid--three">
            <div class="card card--lined">
                <h4>Evidence-backed</h4>
                <p class="muted">Signals come from public disclosures, regulatory filings, and verifiable reports.</p>
            </div>
            <div class="card card--lined">
                <h4>Comparable metrics</h4>
                <p class="muted">Indicators align with transparency, accountability, and oversight themes for consistent benchmarking.</p>
            </div>
            <div class="card card--lined">
                <h4>Reproducible by design</h4>
                <p class="muted">Versioned methodologies and open data paths make it easier to audit, rerun, and extend.</p>
            </div>
        </div>
    </div>
</section>


{{ tech100_snapshot.levels|default:"[]"|json_script:"tech100-home-levels" }}
{{ attribution_snapshot|json_script:"tech100-attribution-snapshot" }}
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/date-format.js' %}?v=20251221" defer></script>
  <script src="{% static 'js/tech100-index.js' %}?v=20251221" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js" crossorigin="anonymous" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/globe.gl@2.29.2/dist/globe.gl.min.js" crossorigin="anonymous" defer></script>
  <script type="module" src="{% static 'js/ai_regulation.js' %}?v={{ static_version }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const snapshotEl = document.getElementById('tech100-attribution-snapshot');
      const snapshot = snapshotEl ? JSON.parse(snapshotEl.textContent || '{}') : null;
      if (!snapshot || !window.Chart) return;

      const toSeries = (rows) => {
        const safeRows = (rows || []).slice(0, 5);
        return {
          labels: safeRows.map((row) => row.ticker || row.name || '‚Äî'),
          values: safeRows.map((row) => (row.value || 0) * 10000),
        };
      };

      const buildChart = (canvasId, series, color) => {
        const el = document.getElementById(canvasId);
        if (!el) return null;
        return new Chart(el.getContext('2d'), {
          type: 'bar',
          data: {
            labels: series.labels,
            datasets: [
              {
                label: 'Contribution (bp)',
                data: series.values,
                backgroundColor: color,
              }
            ],
          },
          options: {
            indexAxis: 'y',
            animation: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { callback: (val) => `${val}` } },
            },
          },
        });
      };

      const getRange = (range) => snapshot.ranges?.[range] || { top: [], worst: [] };
      let topChart = buildChart('tech100-home-top-chart', toSeries(getRange('1d').top), '#2f6f6f');
      let worstChart = buildChart('tech100-home-worst-chart', toSeries(getRange('1d').worst), '#b44a3c');

      document.querySelectorAll('[data-attr-range]').forEach((btn) => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-attr-range]').forEach((el) => {
            el.classList.remove('is-active');
            el.setAttribute('aria-selected', 'false');
          });
          btn.classList.add('is-active');
          btn.setAttribute('aria-selected', 'true');
          const range = btn.dataset.attrRange || '1d';
          const payload = getRange(range);
          const topSeries = toSeries(payload.top);
          const worstSeries = toSeries(payload.worst);
          if (topChart) {
            topChart.data.labels = topSeries.labels;
            topChart.data.datasets[0].data = topSeries.values;
            topChart.update();
          } else {
            topChart = buildChart('tech100-home-top-chart', topSeries, '#2f6f6f');
          }
          if (worstChart) {
            worstChart.data.labels = worstSeries.labels;
            worstChart.data.datasets[0].data = worstSeries.values;
            worstChart.update();
          } else {
            worstChart = buildChart('tech100-home-worst-chart', worstSeries, '#b44a3c');
          }
        });
      });
    });
  </script>
{% endblock %}
