{% extends "base.html" %}
{% load static %}

{% block title %}News | SustainaCore ESG & AI Governance{% endblock %}
{% block meta_description %}Curated headlines on ESG transparency and AI governance, highlighting regulatory moves and accountability signals across the TECH100 cohort.{% endblock %}
{% block structured_data %}
    {% if news_json_ld %}
    <script type="application/ld+json">{{ news_json_ld|safe }}</script>
    {% endif %}
{% endblock %}

{% block content %}
<section class="section section--with-header">
    <div class="shell">
        <div class="section__header section__header--split">
            <div>
                <p class="eyebrow">News &amp; Insights</p>
                <h1>Headlines on ESG transparency and AI governance.</h1>
                <p class="muted">Curated stories that surface transparency updates, regulatory moves, and accountability signals across the TECH100 cohort.</p>
            </div>
            <div class="filters">
                <form class="filters filters--news" method="get">
                    {% if source_supported %}
                    <label>
                        Source
                        <select name="source">
                            <option value="" {% if not filters.source %}selected{% endif %}>All sources</option>
                            {% for source in source_options %}
                            <option value="{{ source }}" {% if filters.source == source %}selected{% endif %}>{{ source }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    {% endif %}
                    {% if tag_supported %}
                    <label>
                        Tag
                        <select name="tag">
                            <option value="" {% if not filters.tag %}selected{% endif %}>All tags</option>
                            {% for tag in tag_options %}
                            <option value="{{ tag }}" {% if filters.tag == tag %}selected{% endif %}>{{ tag }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    {% endif %}
                    {% if ticker_supported %}
                    <label>
                        Ticker
                        <input type="search" name="ticker" placeholder="e.g., MSFT" value="{{ filters.ticker }}">
                    </label>
                    {% endif %}
                    <label>
                        Date range
                        <select name="date_range">
                            {% for option in date_range_options %}
                            <option value="{{ option.value }}" {% if filters.date_range == option.value %}selected{% endif %}>{{ option.label }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <div class="filters__actions">
                        <button class="btn btn--secondary" type="submit">Apply</button>
                    </div>
                </form>
            </div>
        </div>
        {% if news_error %}
        <div class="alert alert--warning">
            {{ news_error }}
        </div>
        {% endif %}
        <div class="news-grid" data-news-list>
            {% if news_error %}
                <article class="news-card news-card--empty" data-news-empty-state>
                    <p class="muted">News is temporarily unavailable. Please try again in a moment.</p>
                </article>
            {% elif articles %}
                {% for article in articles %}
                <article class="news-card">
                    {% if article.has_full_body and article.id %}
                    <a class="news-card__link" href="{% url 'news_detail' article.id %}{% if back_query %}?back={{ back_query|urlencode }}{% endif %}" data-news-link>
                    {% elif article.url %}
                    <a class="news-card__link" href="{{ article.url }}" target="_blank" rel="noopener noreferrer" data-news-link data-news-external>
                    {% else %}
                    <div class="news-card__link">
                    {% endif %}
                        <div class="news-card__meta">
                            {{ article.source }}{% if article.published_at %} · {{ article.published_at|date:"M j, Y" }}{% endif %}
                        </div>
                        <h3 class="news-card__title">{{ article.title }}</h3>
                        <p class="muted">{{ article.summary|default_if_none:""|truncatechars:240 }}</p>
                        {% if article.tags or article.categories or article.pillar_tags or article.ticker %}
                        <div class="news-card__tags">
                            {% if article.ticker %}
                            <span class="tag tag--brand">{{ article.ticker }}</span>
                            {% endif %}
                            {% if article.tags %}
                                {% for tag in article.tags %}
                                <span class="tag">{{ tag }}</span>
                                {% endfor %}
                            {% endif %}
                            {% if article.categories %}
                                {% for category in article.categories %}
                                <span class="tag tag--muted">{{ category }}</span>
                                {% endfor %}
                            {% endif %}
                            {% if article.pillar_tags %}
                                {% for pillar_tag in article.pillar_tags %}
                                <span class="tag tag--muted">{{ pillar_tag }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                        <span class="news-card__cta">
                            {% if article.has_full_body and article.id %}Read full article →{% else %}Open source →{% endif %}
                        </span>
                    {% if article.has_full_body or article.url %}
                    </a>
                    {% else %}
                    </div>
                    {% endif %}
                </article>
                {% endfor %}
            {% else %}
                <article class="news-card news-card--empty" data-news-empty-state>
                    <p class="muted">No results for this filter or date range.</p>
                </article>
            {% endif %}
        </div>
        {% if prev_url or next_url %}
        <div class="load-more">
            <div class="load-more__actions">
                {% if prev_url %}
                <a class="btn btn--secondary" href="{{ prev_url }}">Previous</a>
                {% else %}
                <button class="btn btn--secondary" type="button" disabled>Previous</button>
                {% endif %}
                {% if next_url %}
                <a class="btn btn--secondary" href="{{ next_url }}">Next</a>
                {% else %}
                <button class="btn btn--secondary" type="button" disabled>Next</button>
                {% endif %}
            </div>
            <p class="muted">
                Showing {{ news_meta.count|default:articles|length }} of recent stories.
            </p>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
    <script src="{% static 'js/news.js' %}"></script>
{% endblock %}
